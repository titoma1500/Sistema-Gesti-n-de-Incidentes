@page "/incidentes/crear"
@rendermode InteractiveServer
@using Proyecto.Application.DTOs.Incidentes
@using Proyecto.Application.DTOs.Etiqueta
@using Proyecto.Application.Interfaces
@inject IIncidenteService IncidenteService
@inject IEtiquetaService EtiquetaService
@inject ISessionService SessionService
@inject NavigationManager Navigation

<PageTitle>Crear Incidente</PageTitle>

<div class="container">
    <h3><i class="fas fa-plus-circle me-2"></i>Crear Nuevo Incidente</h3>
    
    @if (!string.IsNullOrEmpty(mensaje))
    {
        <div class="alert @(mensajeExito ? "alert-success" : "alert-danger") alert-dismissible fade show mt-3">
            @mensaje
            <button type="button" class="btn-close" @onclick="() => mensaje = null"></button>
        </div>
    }
    
    <div class="card mt-3">
        <div class="card-body">
            <EditForm Model="nuevoIncidente" OnValidSubmit="CrearIncidente" FormName="crearIncidenteForm">
                <DataAnnotationsValidator />
                
                <div class="mb-3">
                    <label class="form-label"><i class="fas fa-heading me-1"></i>Título:</label>
                    <InputText class="form-control" @bind-Value="nuevoIncidente.Titulo"
                               placeholder="Ej: Impresora no funciona en Lab 3" />
                    <ValidationMessage For="@(() => nuevoIncidente.Titulo)" />
                </div>
                
                <div class="mb-3">
                    <label class="form-label"><i class="fas fa-align-left me-1"></i>Descripción detallada:</label>
                    <InputTextArea class="form-control" rows="5" 
                                   @bind-Value="nuevoIncidente.Descripcion"
                                   placeholder="Describe el problema en detalle..." />
                    <ValidationMessage For="@(() => nuevoIncidente.Descripcion)" />
                </div>
                
                <div class="mb-3">
                    <label class="form-label"><i class="fas fa-exclamation-triangle me-1"></i>Prioridad:</label>
                    <InputSelect class="form-select" @bind-Value="nuevoIncidente.PrioridadId">
                        <option value="1">Baja</option>
                        <option value="2">Media</option>
                        <option value="3">Alta</option>
                        <option value="4">Crítica</option>
                    </InputSelect>
                </div>
                
                <div class="mb-3">
                    <label class="form-label"><i class="fas fa-tags me-1"></i>Etiquetas (máximo 2):</label>
                    @if (nuevoIncidente.EtiquetasIds.Count >= 2)
                    {
                        <div class="alert alert-info mt-2">
                            <small>Máximo 2 etiquetas seleccionadas</small>
                        </div>
                    }
                    <div class="row">
                        @foreach (var etiqueta in etiquetas)
                        {
                            <div class="col-md-6 mb-2">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="etiqueta-@etiqueta.Id"
                                           checked="@nuevoIncidente.EtiquetasIds.Contains(etiqueta.Id)"
                                           disabled="@(!nuevoIncidente.EtiquetasIds.Contains(etiqueta.Id) && nuevoIncidente.EtiquetasIds.Count >= 2)"
                                           @onchange="@(() => ToggleEtiqueta(etiqueta.Id))" />
                                    <label class="form-check-label" for="etiqueta-@etiqueta.Id">
                                        <i class="fas fa-tag me-1"></i>@etiqueta.Nombre
                                    </label>
                                </div>
                            </div>
                        }
                    </div>
                </div>
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check me-1"></i>Crear Incidente
                    </button>
                    <button type="button" class="btn btn-secondary" 
                            @onclick="Cancelar">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private CrearIncidenteDto nuevoIncidente { get; set; } = new() 
    { 
        PrioridadId = 2,
        EtiquetasIds = new List<int>()
    };
    
    private List<EtiquetaDto> etiquetas = new();
    private string? mensaje;
    private bool mensajeExito = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var usuario = await SessionService.GetUsuarioActualAsync();
            
            if (usuario != null)
            {
                // Validar límite de incidentes para estudiantes
                if (usuario.Nivel == 0)
                {
                    var puedeCrear = await IncidenteService.ValidarLimiteIncidentesAsync(usuario.Id);
                    if (!puedeCrear)
                    {
                        mensaje = "Has alcanzado el límite de 3 incidentes activos. Debes esperar a que al menos uno sea resuelto, cerrado o descartado para crear uno nuevo.";
                        mensajeExito = false;
                        StateHasChanged();
                        return;
                    }
                }
                
                nuevoIncidente.UsuarioReportaId = usuario.Id;
                
                // Cargar etiquetas disponibles
                var todasEtiquetas = await EtiquetaService.ObtenerTodasAsync();
                etiquetas = todasEtiquetas.ToList();
                
                StateHasChanged();
            }
            else
            {
                Navigation.NavigateTo("/login");
            }
        }
    }
    
    private void ToggleEtiqueta(int etiquetaId)
    {
        if (nuevoIncidente.EtiquetasIds.Contains(etiquetaId))
        {
            nuevoIncidente.EtiquetasIds.Remove(etiquetaId);
        }
        else
        {
            nuevoIncidente.EtiquetasIds.Add(etiquetaId);
        }
    }

    private async Task CrearIncidente()
    {
        try
        {
            await IncidenteService.CrearAsync(nuevoIncidente);
            
            mensaje = "✓ Incidente creado exitosamente";
            mensajeExito = true;
            StateHasChanged();
            
            // Esperar 1.5 segundos para mostrar el mensaje
            await Task.Delay(1500);
            
            // Todos regresan a /incidentes
            Navigation.NavigateTo("/incidentes", forceLoad: true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al crear incidente: {ex.Message}");
            mensaje = $"Error al crear incidente: {ex.Message}";
            mensajeExito = false;
        }
    }

    private void Cancelar()
    {
        Navigation.NavigateTo("/incidentes");
    }
}
